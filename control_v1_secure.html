<!DOCTYPE html>
<html lang="en" ng-app="adminApp">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>F1 Admin | Control Center</title>
    
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Titillium+Web:ital,wght@0,300;0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <style>
        :root {
            --primary: #ff1801;
            --primary-bright: #ff3b26;
            --bg-deep: #0b0b0d;
            --bg-surface: #15151e;
            --bg-card: #1e1e26;
            --text-main: #ffffff;
            --text-muted: #8a8a95;
            --border: #2f2f38;
            --live-green: #00d26a;
            --upcoming-orange: #ffb700;
        }

        body {
            background-color: var(--bg-deep);
            background-image: radial-gradient(circle at 50% 0%, #2a2a35 0%, transparent 70%);
            color: var(--text-main);
            font-family: 'Titillium Web', sans-serif;
            margin: 0; padding-bottom: 80px;
        }

        h2, h3 { 
            font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px; 
            margin: 0 0 20px 0; border-left: 4px solid var(--primary);
            padding-left: 15px; line-height: 1;
        }
        h2 { font-size: 24px; }
        h3 { font-size: 18px; color: #ddd; }

        .container { max-width: 1100px; margin: 0 auto; padding: 0 20px; }
        .animate-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- ACTION BAR --- */
        .action-bar {
            position: sticky; top: 10px; z-index: 1000;
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(21, 21, 30, 0.95);
            backdrop-filter: blur(12px);
            padding: 15px 20px; border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            margin: 10px 0 20px 0;
        }
        .brand-logo { font-size: 20px; font-weight: 800; font-style: italic; display: flex; align-items: center; gap: 12px; }
        .brand-logo i { color: var(--primary); }

        .status-badge { font-size: 10px; font-weight: 600; text-transform: uppercase; padding: 4px 10px; border-radius: 20px; display: none; }
        .status-badge.success { display: block; background: rgba(0, 255, 136, 0.15); color: #00ff88; border: 1px solid #00ff88; }
        .status-badge.loading { display: block; background: rgba(255, 183, 0, 0.15); color: #ffb700; border: 1px solid #ffb700; }
        .status-badge.error { display: block; background: rgba(255, 24, 1, 0.15); color: #ff1801; border: 1px solid #ff1801; }

        /* --- TABS --- */
        .tab-container {
            display: flex; gap: 10px; margin-bottom: 25px;
            background: #111; padding: 5px; border-radius: 8px; border: 1px solid var(--border);
        }
        .tab-btn {
            flex: 1; background: transparent; border: none; color: #666; padding: 12px;
            font-weight: 700; text-transform: uppercase; cursor: pointer; border-radius: 6px;
            transition: 0.3s;
        }
        .tab-btn.active {
            background: var(--bg-card); color: white; box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            border: 1px solid var(--border);
        }
        .tab-btn:hover:not(.active) { color: #aaa; background: rgba(255,255,255,0.05); }

        /* --- BUTTONS --- */
        button {
            position: relative; background: rgba(255, 255, 255, 0.05); color: white; 
            border: 1px solid rgba(255, 255, 255, 0.1); padding: 10px 20px; 
            border-radius: 8px; font-weight: 700; font-size: 11px;
            cursor: pointer; text-transform: uppercase; letter-spacing: 1px;
            display: inline-flex; align-items: center; gap: 8px; justify-content: center;
            transition: all 0.3s;
        }
        button:hover { background: rgba(255, 255, 255, 0.1); transform: translateY(-2px); }
        button:disabled { opacity: 0.7; cursor: not-allowed; transform: none; }
        
        button.primary-btn { background: var(--primary); border: 1px solid var(--primary); box-shadow: 0 0 15px rgba(255, 24, 1, 0.3); color: white; }
        button.primary-btn:hover { background: var(--primary-bright); }
        
        button.dashed-btn { background: transparent; border: 1px dashed #555; color: #888; }
        button.icon-btn { padding: 8px; width: 32px; height: 32px; border-radius: 50%; border: 1px solid transparent; background: transparent; color: #666; }
        button.icon-btn:hover { color: white; background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); }
        button.delete-btn:hover { color: var(--primary); background: rgba(255, 24, 1, 0.15); border-color: var(--primary); }

        /* --- LOADING SPINNER --- */
        .loading-spinner {
            width: 14px; height: 14px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid #fff;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- TOAST NOTIFICATIONS --- */
        .toast-container {
            position: fixed; bottom: 30px; right: 30px; z-index: 2000;
            display: flex; flex-direction: column; gap: 10px; pointer-events: none;
        }
        .toast {
            background: #1e1e26; border-left: 4px solid #333;
            padding: 15px 20px; border-radius: 4px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.6);
            min-width: 250px; color: #fff;
            animation: slideIn 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            display: flex; align-items: center; gap: 12px;
            pointer-events: auto;
        }
        .toast.success { border-color: var(--live-green); }
        .toast.success i { color: var(--live-green); }
        
        .toast.error { border-color: var(--primary); }
        .toast.error i { color: var(--primary); }

        @keyframes slideIn { from { transform: translateX(120%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* --- FORMS --- */
        .admin-section {
            background: var(--bg-card); padding: 25px; border-radius: 12px;
            border: 1px solid var(--border); margin-bottom: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        .grid-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .input-group { margin-bottom: 15px; width: 100%; }
        label { display: block; font-size: 10px; color: var(--text-muted); margin-bottom: 6px; text-transform: uppercase; font-weight: 600; }
        input, select, textarea {
            width: 100%; background: rgba(0,0,0,0.2); 
            border: 1px solid var(--border); border-left: 2px solid var(--border);
            color: white; padding: 12px; border-radius: 4px;
            font-family: 'Titillium Web', sans-serif; font-size: 14px;
            box-sizing: border-box; transition: 0.3s;
        }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #777; border-left-color: var(--primary); background: rgba(0,0,0,0.4); }

        /* --- SCHEDULE & DRIVER LISTS --- */
        .session-card { background: rgba(0,0,0,0.3); padding: 15px; margin-bottom: 15px; border-radius: 6px; position: relative; border: 1px solid transparent; transition: 0.3s; }
        .session-card.is-live { border-color: var(--live-green); background: rgba(0, 210, 106, 0.05); }
        .session-card.is-upcoming { border-color: var(--upcoming-orange); background: rgba(255, 183, 0, 0.05); }
        
        .live-indicator, .upcoming-indicator, .timer-badge {
            position: absolute; top: -10px; left: 10px; font-size: 9px; font-weight: 800; padding: 2px 8px; border-radius: 4px; text-transform: uppercase; z-index: 20;
        }
        .live-indicator { background: var(--live-green); color: #000; animation: pulse 2s infinite; }
        .upcoming-indicator { background: var(--upcoming-orange); color: #000; }
        .timer-badge { left: 70px; background: #111; color: #fff; border: 1px solid #444; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        .schedule-grid-top { display: grid; grid-template-columns: 0.5fr 0.8fr 2fr; gap: 10px; margin-bottom: 10px; }
        .schedule-grid-bot { display: grid; grid-template-columns: 1fr 1fr 1.5fr; gap: 10px; }

        .driver-list-header { display: grid; grid-template-columns: 40px 50px 2fr 1.5fr 0.8fr 1fr 50px; gap: 10px; padding: 0 10px 10px; margin-bottom: 5px; border-bottom: 1px solid var(--border); color: var(--text-muted); font-size: 10px; }
        .driver-row { display: grid; grid-template-columns: 40px 50px 2fr 1.5fr 0.8fr 1fr 50px; gap: 10px; align-items: center; background: #25252e; padding: 10px; margin-bottom: 8px; border-radius: 6px; transition:0.2s; }
        .driver-row:hover { background: #2b2b35; transform:translateX(5px); }
        .img-preview { width: 36px; height: 36px; border-radius: 50%; background: #000; object-fit: cover; border: 2px solid var(--border); }
        .lg-preview { width: 100px; height: 100px; border-radius: 50%; margin: 10px auto; display: block; border: 4px solid var(--border); }

        /* Login Overlay */
        .login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 999; display: flex; justify-content: center; align-items: center; }
        .login-box { background: var(--bg-surface); padding: 40px 30px; border-radius: 16px; border: 1px solid var(--border); width: 90%; max-width: 350px; text-align: center; }

        /* Custom Toggle Switch (Large - Maintenance Mode) */
        .toggle-label { cursor: pointer; display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; border: 1px solid var(--border); }
        .toggle-switch { position: relative; width: 50px; height: 26px; background: #333; border-radius: 20px; transition: 0.3s; }
        .toggle-switch::after { content: ''; position: absolute; top: 3px; left: 3px; width: 20px; height: 20px; background: #fff; border-radius: 50%; transition: 0.3s; }
        input[type="checkbox"]:checked + .toggle-switch { background: var(--primary); }
        input[type="checkbox"]:checked + .toggle-switch::after { left: 27px; }

        /* Custom Small Switch (Green - Winner Profile) */
        .small-switch { position: relative; width: 44px; height: 24px; display: inline-block; vertical-align: middle; }
        .small-switch input { opacity: 0; width: 0; height: 0; }
        .small-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 24px; border: 1px solid #555; }
        .small-slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: #888; transition: .4s; border-radius: 50%; }
        input:checked + .small-slider { background-color: rgba(0, 255, 136, 0.15); border-color: var(--live-green); }
        input:checked + .small-slider:before { transform: translateX(20px); background-color: var(--live-green); box-shadow: 0 0 10px var(--live-green); }

        @media (max-width: 768px) {
            .driver-list-header { display: none; }
            .driver-row { display: flex; flex-wrap: wrap; gap: 10px; position: relative; padding:15px; border:1px solid #333; }
            .driver-row input { width: 100%; }
            .schedule-grid-top, .schedule-grid-bot { grid-template-columns: 1fr; }
            .driver-row button.delete-btn { position: absolute; top: 10px; right: 10px; }
        }
    </style>
</head>
<body ng-controller="AdminController">

    <div class="toast-container">
        <div ng-repeat="t in toasts" class="toast" ng-class="t.type">
            <i class="fa-solid" ng-class="t.type === 'success' ? 'fa-circle-check' : 'fa-circle-exclamation'"></i>
            <div>
                <div style="font-weight:700; font-size:12px; margin-bottom:2px; text-transform:uppercase;">{{t.title}}</div>
                <div style="font-size:11px; color:#aaa;">{{t.msg}}</div>
            </div>
        </div>
    </div>

    <div class="login-overlay animate-in" ng-if="!isLoggedIn">
        <div class="login-box">
            <div style="font-size: 40px; color: var(--primary); margin-bottom: 20px;"><i class="fa-solid fa-flag-checkered"></i></div>
            <h2 style="border:none; padding:0; margin-bottom: 10px;">Admin Login</h2>
            <form ng-submit="login()">
                <div class="input-group"><input type="email" ng-model="creds.email" placeholder="Email" required></div>
                <div class="input-group"><input type="password" ng-model="creds.pass" placeholder="Password" required></div>
                <button type="submit" class="primary-btn" style="width:100%;">Login</button>
            </form>
            <p style="color: var(--primary); font-size: 12px; margin-top: 20px;">{{loginError}}</p>
        </div>
    </div>

    <div class="container animate-in" ng-if="isLoggedIn">
        
        <div class="action-bar">
            <div class="brand-logo">
                <i class="fa-solid fa-tower-broadcast"></i>
                <div>WatchParty Web Admin Panel</div>
                <div class="status-badge" ng-class="statusType">{{statusText}}</div>
            </div>
            <div>
                <button class="icon-btn" ng-click="logout()" title="Logout" style="border: 1px solid #444;"><i class="fa-solid fa-power-off"></i></button>
            </div>
        </div>

        <div class="tab-container">
            <button class="tab-btn" ng-class="{'active': currentView === 'live'}" ng-click="currentView = 'live'"><i class="fa-solid fa-video"></i> Stream Control</button>
            <button class="tab-btn" ng-class="{'active': currentView === 'maint'}" ng-click="currentView = 'maint'"><i class="fa-solid fa-wrench"></i> Maintenance Mode</button>
        </div>

        <div ng-show="currentView === 'live'">
            
            <div style="display: flex; justify-content: flex-end; margin-bottom: 10px;">
                <button class="primary-btn" ng-click="saveLiveConfig()" ng-disabled="savingLive">
                    <i class="fa-solid fa-cloud-arrow-up" ng-if="!savingLive"></i>
                    <div class="loading-spinner" ng-if="savingLive"></div>
                    <span>{{ savingLive ? 'Saving...' : 'Save Live Settings' }}</span>
                </button>
            </div>

            <div class="grid-row">
                <div class="admin-section">
                    <h3><i class="fa-solid fa-calendar-day" style="color: var(--primary); margin-right: 10px;"></i> Session Details</h3>
                    <div class="grid-row">
                        <div class="input-group"><label>Round</label><input type="text" ng-model="config.raceData.round"></div>
                        <div class="input-group"><label>Grand Prix Name</label><input type="text" ng-model="config.raceData.name"></div>
                    </div>
                    <div class="grid-row">
                        <div class="input-group"><label>Circuit Name</label><input type="text" ng-model="config.raceData.circuit"></div>
                        
                        <div class="input-group">
                            <label style="color:var(--primary-bright);">Location (For Auto Weather)</label>
                            <input type="text" ng-model="config.raceData.location" placeholder="e.g. Las Vegas">
                        </div>
                    </div>
                    <div class="grid-row">
                        <div class="input-group"><label>Date String</label><input type="text" ng-model="config.raceData.date"></div>
                        <div class="input-group"><label>Laps / Duration</label><input type="text" ng-model="config.raceData.laps"></div>
                    </div>
                </div>

                <div class="admin-section">
                    <h3><i class="fa-solid fa-cloud-sun-rain" style="color: var(--primary); margin-right: 10px;"></i> Manual Weather</h3>
                    <p style="font-size:10px; color:#666; margin-bottom:10px;">Only used if Location is empty or API fails.</p>
                    <div class="input-group">
                        <label>Condition</label>
                        <select ng-model="config.weather.condition" style="background: rgba(0,0,0,0.2); color:white;">
                            <option value="sunny">Sunny / Clear</option>
                            <option value="cloudy">Cloudy</option>
                            <option value="rain">Rain / Wet</option>
                            <option value="storm">Thunderstorm</option>
                            <option value="night">Clear Night</option>
                        </select>
                    </div>
                    <div class="grid-row">
                        <div class="input-group">
                            <label>Air Temp (°C)</label>
                            <input type="number" ng-model="config.weather.air" placeholder="24">
                        </div>
                        <div class="input-group">
                            <label>Track Temp (°C)</label>
                            <input type="number" ng-model="config.weather.track" placeholder="32">
                        </div>
                    </div>
                </div>
            </div>

            <div class="admin-section">
                <h3><i class="fa-solid fa-forward" style="color: var(--primary); margin-right: 10px;"></i> Up Next Widget</h3>
                <div style="margin-bottom: 20px;"><label><input type="checkbox" ng-model="config.nextRace.isVisible" style="width:auto;"> Show Widget</label></div>
                <div class="input-group"><label>Event Name</label><input type="text" ng-model="config.nextRace.name"></div>
                <div class="grid-row">
                    <div class="input-group"><label>Date</label><input type="text" ng-model="config.nextRace.date"></div>
                    <div class="input-group"><label>Circuit</label><input type="text" ng-model="config.nextRace.circuit"></div>
                </div>
            </div>

            <div class="admin-section">
                <h3><i class="fa-solid fa-stopwatch" style="color: var(--primary); margin-right: 10px;"></i> Weekend Schedule</h3>
                <p style="font-size: 11px; color: #666; margin-bottom: 15px;">Ensure "Timer ISO" is format: <strong>YYYY-MM-DDTHH:MM:00</strong></p>
                
                <div ng-repeat="session in config.schedule" class="session-card" ng-class="{'is-live': session.isLive, 'is-upcoming': session.isUpcoming}">
                    
                    <div class="live-indicator" ng-if="session.isLive"><i class="fa-solid fa-circle fa-beat" style="font-size:8px; margin-right:4px;"></i> LIVE NOW</div>
                    <div class="upcoming-indicator" ng-if="session.isUpcoming"><i class="fa-solid fa-clock" style="margin-right:4px;"></i> UP NEXT</div>
                    <div class="timer-badge" ng-if="session.isUpcoming">{{session.countdown}}</div>

                    <div style="position: absolute; right: 10px; top: 10px; display: flex; gap: 5px; z-index: 10;">
                        <button class="icon-btn" ng-click="moveSessionUp($index)" ng-if="!$first" title="Move Up" style="width: 24px; height: 24px; font-size: 10px;"><i class="fa-solid fa-chevron-up"></i></button>
                        <button class="icon-btn" ng-click="moveSessionDown($index)" ng-if="!$last" title="Move Down" style="width: 24px; height: 24px; font-size: 10px;"><i class="fa-solid fa-chevron-down"></i></button>
                        <button class="icon-btn delete-btn" ng-click="removeSession($index)" title="Remove" style="width: 24px; height: 24px; font-size: 10px;"><i class="fa-solid fa-trash"></i></button>
                    </div>

                    <div class="schedule-grid-top">
                        <div class="input-group" style="margin-bottom:0;">
                            <label ng-if="$first"><i class="fa-solid fa-calendar"></i> Day</label>
                            <input type="text" ng-model="session.day" placeholder="FRI">
                        </div>
                        <div class="input-group" style="margin-bottom:0;">
                            <label ng-if="$first"><i class="fa-solid fa-calendar-days"></i> Date</label>
                            <input type="text" ng-model="session.date" placeholder="24 NOV">
                        </div>
                        <div class="input-group" style="margin-bottom:0;">
                            <label ng-if="$first"><i class="fa-solid fa-flag"></i> Session Name</label>
                            <input type="text" ng-model="session.name" placeholder="Practice 1">
                        </div>
                    </div>

                    <div class="schedule-grid-bot">
                        <div class="input-group" style="margin-bottom:0;">
                            <label ng-if="$first"><i class="fa-solid fa-play"></i> Start</label>
                            <input type="text" ng-model="session.time" placeholder="14:00">
                        </div>
                        <div class="input-group" style="margin-bottom:0;">
                            <label ng-if="$first"><i class="fa-solid fa-stop"></i> End</label>
                            <input type="text" ng-model="session.endTime" placeholder="15:00">
                        </div>
                        <div class="input-group" style="margin-bottom:0;">
                            <label ng-if="$first"><i class="fa-solid fa-hourglass"></i> Timer ISO</label>
                            <input type="text" ng-model="session.timer" placeholder="YYYY-MM-DDTHH:MM:00">
                        </div>
                    </div>
                </div>
                
                <button class="dashed-btn" ng-click="addSession()" style="width: 100%; justify-content: center; margin-top: 10px;">
                    <i class="fa-solid fa-plus"></i> Add Session
                </button>
            </div>

            <div class="admin-section">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 25px;">
                    <h3><i class="fa-solid fa-list-ol" style="color: var(--primary); margin-right: 10px;"></i> Standings</h3>
                    <div>
                        <button ng-click="sortDrivers()"><i class="fa-solid fa-arrow-down-9-1"></i></button>
                        <button ng-click="addDriver()"><i class="fa-solid fa-plus"></i> Add</button>
                    </div>
                </div>
                
                <div class="driver-list-header">
                    <span style="text-align: center;">ORD</span> <span style="text-align: center;">IMG</span> <span>NAME</span> <span>TEAM</span> <span>PTS</span> <span>IMG URL</span> <span style="text-align: center;">DEL</span>
                </div>
                
                <div ng-repeat="driver in config.standings" class="driver-row">
                    <div style="display:flex; flex-direction:column; gap:2px;">
                        <button style="background:none; border:none; padding:0; color:#666; font-size:12px; cursor:pointer;" ng-click="moveUp($index)" ng-if="!$first"><i class="fa-solid fa-chevron-up"></i></button>
                        <button style="background:none; border:none; padding:0; color:#666; font-size:12px; cursor:pointer;" ng-click="moveDown($index)" ng-if="!$last"><i class="fa-solid fa-chevron-down"></i></button>
                    </div>
                    <div style="text-align: center;"><img ng-src="{{driver.image}}" class="img-preview" onerror="this.src='https://media.formula1.com/d_driver_fallback_image.png/content/dam/fom-website/drivers/driver-fallback-image.png.transform/2col/image.png'"></div>
                    
                    <input type="text" ng-model="driver.name" placeholder="Driver Name">
                    <input type="text" ng-model="driver.team" placeholder="Team">
                    <input type="number" ng-model="driver.points" placeholder="0">
                    <input type="text" ng-model="driver.image" placeholder="Image URL">
                    
                    <button class="icon-btn delete-btn" ng-click="removeDriver($index)"><i class="fa-solid fa-trash"></i></button>
                </div>
            </div>

            <div class="admin-section">
                <h3><i class="fa-solid fa-video" style="color: var(--primary); margin-right: 10px;"></i> Stream Sources</h3>
                <div ng-repeat="link in config.streamLinks" style="background: rgba(0,0,0,0.3); padding: 15px; margin-bottom: 15px; border-radius: 6px;">
                    <div class="grid-row" style="margin-bottom: 10px;">
                        <input type="text" ng-model="link.name" placeholder="Name">
                        <input type="text" ng-model="link.id" readonly style="color: #666;">
                    </div>
                    <input type="text" ng-model="link.url" placeholder="Embed URL">
                    <button ng-click="removeStream($index)" class="icon-btn delete-btn" style="width: auto; height: auto; border-radius: 4px; font-size:10px; padding:8px 15px; margin-top: 10px; border: 1px solid #444;">
                        <i class="fa-solid fa-trash" style="margin-right:5px;"></i> Remove
                    </button>
                </div>
                <button class="dashed-btn" ng-click="addStream()" style="width: 100%; justify-content: center; margin-top: 10px;"><i class="fa-solid fa-plus"></i> Add New Source</button>
            </div>
        </div>


        <div ng-show="currentView === 'maint'">
            
            <div style="display: flex; justify-content: flex-end; margin-bottom: 10px;">
                <button class="primary-btn" ng-click="saveMaintConfig()" ng-disabled="savingMaint">
                    <i class="fa-solid fa-cloud-arrow-up" ng-if="!savingMaint"></i>
                    <div class="loading-spinner" ng-if="savingMaint"></div>
                    <span>{{ savingMaint ? 'Saving...' : 'Save Maintenance' }}</span>
                </button>
            </div>

            <div class="admin-section" style="border-left: 4px solid {{maintConfig.isActive ? '#ff1801' : '#00d26a'}};">
                <label class="toggle-label">
                    <div>
                        <div style="font-size: 14px; font-weight: 700; color: white;"> MAINTENANCE MODE</div>
                        <div style="font-size: 11px; color: #888;">{{maintConfig.isActive ? 'Site is currently HIDDEN (Maintenance Page)' : 'Site is currently LIVE'}}</div>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <input type="checkbox" ng-model="maintConfig.isActive" style="display: none;" id="maintSwitch">
                        <label for="maintSwitch" class="toggle-switch"></label>
                    </div>
                </label>
            </div>

            <div class="admin-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>Winner Profile</h3>
                    
                    <label style="display: flex; align-items: center; cursor: pointer; margin: 0;">
                        <div style="font-size: 10px; font-weight: 700; color: #888; margin-right: 10px; text-transform: uppercase;">
                            {{ maintConfig.showWinner ? 'Visible' : 'Hidden' }}
                        </div>
                        <div class="small-switch">
                            <input type="checkbox" ng-model="maintConfig.showWinner">
                            <span class="small-slider"></span>
                        </div>
                    </label>
                </div>

                <div class="grid-row" style="transition: 0.3s;" ng-style="{ opacity: maintConfig.showWinner ? '1' : '0.4' }">
                    <div>
                        <div class="input-group">
                            <label>Winner Name</label>
                            <input type="text" ng-model="maintConfig.winnerName" ng-disabled="!maintConfig.showWinner">
                        </div>
                        <div class="input-group">
                            <label>Team Name</label>
                            <input type="text" ng-model="maintConfig.winnerTeam" ng-disabled="!maintConfig.showWinner">
                        </div>
                        <div class="input-group">
                            <label>Image URL</label>
                            <input type="text" ng-model="maintConfig.winnerImage" ng-disabled="!maintConfig.showWinner">
                        </div>
                    </div>
                    <div style="text-align: center;">
                        <label>Preview</label>
                        <img ng-src="{{maintConfig.winnerImage}}" class="lg-preview" 
                             ng-style="{ filter: maintConfig.showWinner ? 'none' : 'grayscale(100%)' }">
                    </div>
                </div>
            </div>

            <div class="admin-section">
                <h3>Theme & Timer</h3>
                <div class="grid-row">
                    <div class="input-group">
                        <label>Theme Color (Hex)</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="color" ng-model="maintConfig.themeColor" style="height: 45px; width: 60px; padding: 0;">
                            <input type="text" ng-model="maintConfig.themeColor">
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label>Counter Title</label>
                        <input type="text" ng-model="maintConfig.timerTitle" placeholder="e.g. Season Starts In">
                    </div>
                </div>

                <div class="input-group">
                    <label>Target Date (Ex: March 1, 2026 12:00:00)</label>
                    <input type="text" ng-model="maintConfig.targetDate">
                </div>
            </div>
            
            <div class="admin-section">
                <h3>Messaging</h3>
                <div class="input-group"><label>Title</label><input type="text" ng-model="maintConfig.msgTitle"></div>
                <div class="input-group"><label>Subtitle</label><textarea ng-model="maintConfig.msgSub" rows="3"></textarea></div>
            </div>
        </div>

    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDddLbKsv7BCiXQeFy9jzuFrmuWv8qt3DM",
            authDomain: "f1-stream-live.firebaseapp.com",
            projectId: "f1-stream-live",
            storageBucket: "f1-stream-live.firebasestorage.app",
            messagingSenderId: "426806288804",
            appId: "1:426806288804:web:f8ee225776596ebc39e131",
            measurementId: "G-50FMFWY32X"
        };
        
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        var app = angular.module('adminApp', []);

        app.controller('AdminController', function($scope, $timeout, $interval) {
            $scope.currentView = 'live'; 
            $scope.isLoggedIn = false;
            $scope.creds = { email: "", pass: "" };
            $scope.config = {}; 
            $scope.maintConfig = {}; 
            $scope.savingLive = false;
            $scope.savingMaint = false;

            // --- TOAST LOGIC ---
            $scope.toasts = [];
            $scope.showToast = function(msg, type = 'success') {
                const id = Date.now();
                const title = type === 'success' ? 'Success' : 'Error';
                $scope.toasts.push({ id, msg, type, title });
                $timeout(() => {
                    const index = $scope.toasts.findIndex(t => t.id === id);
                    if(index > -1) $scope.toasts.splice(index, 1);
                }, 3000);
            };

            // --- AUTH ---
            auth.onAuthStateChanged(user => {
                $scope.$apply(() => {
                    $scope.isLoggedIn = !!user;
                    if(user) $scope.loadAllData();
                });
            });

            $scope.login = function() {
                $scope.loginError = "Authenticating...";
                auth.signInWithEmailAndPassword($scope.creds.email, $scope.creds.pass)
                    .catch(e => $scope.$apply(() => $scope.loginError = e.message));
            };
            $scope.logout = () => auth.signOut();

            // --- DATA LOADING ---
            $scope.loadAllData = function() {
                db.collection("app_data").doc("live_config").get().then(doc => {
                    $scope.$apply(() => {
                        $scope.config = doc.exists ? doc.data() : {};
                        if (!$scope.config.standings) $scope.config.standings = [];
                        if (!$scope.config.streamLinks) $scope.config.streamLinks = [];
                        if (!$scope.config.schedule) $scope.config.schedule = [];
                        if (!$scope.config.weather) $scope.config.weather = { air: 0, track: 0, condition: 'sunny' };
                        if (!$scope.config.raceData) $scope.config.raceData = {};
                        if (!$scope.config.nextRace) $scope.config.nextRace = {};
                    });
                });

                db.collection("app_data").doc("maintenance_config").get().then(doc => {
                    $scope.$apply(() => {
                        $scope.maintConfig = doc.exists ? doc.data() : {
                            isActive: false, 
                            showWinner: false, 
                            winnerName: "LANDO NORRIS",
                            winnerTeam: "McLAREN FORMULA 1 TEAM",
                            themeColor: "#FF8700",
                            targetDate: "March 1, 2026 12:00:00",
                            winnerImage: "",
                            msgTitle: "Website Under Maintenance",
                            msgSub: "Preparing for the new season",
                            timerTitle: "Season Starts In"
                        };
                        
                        // Safety Checks
                        if($scope.maintConfig.isActive === undefined) $scope.maintConfig.isActive = false;
                        if($scope.maintConfig.showWinner === undefined) $scope.maintConfig.showWinner = false;
                        
                        // --- NEW CHECK for timerTitle ---
                        if($scope.maintConfig.timerTitle === undefined) $scope.maintConfig.timerTitle = "Season Starts In";
                    });
                });
            };

            // --- SAVE FUNCTIONS ---
            $scope.saveLiveConfig = function() {
                $scope.savingLive = true; 
                $scope.statusText = "SAVING..."; 
                $scope.statusType = "loading";

                let dataToSave = angular.copy($scope.config);
                if(dataToSave.schedule) {
                    dataToSave.schedule.forEach(s => { delete s.isLive; delete s.isUpcoming; delete s.countdown; });
                }
                
                db.collection("app_data").doc("live_config").set(JSON.parse(angular.toJson(dataToSave)))
                    .then(() => {
                        $scope.$apply(() => { 
                            $scope.savingLive = false; 
                            $scope.statusText = "LIVE"; 
                            $scope.statusType = "success"; 
                            $scope.showToast("Live Settings Saved Successfully!", "success");
                        });
                    })
                    .catch(e => {
                        $scope.$apply(() => {
                            $scope.savingLive = false; 
                            $scope.showToast("Error: " + e.message, "error");
                        });
                    });
            };

            $scope.saveMaintConfig = function() {
                $scope.savingMaint = true; 
                db.collection("app_data").doc("maintenance_config").set(JSON.parse(angular.toJson($scope.maintConfig)))
                    .then(() => {
                        $scope.$apply(() => {
                            $scope.savingMaint = false; 
                            $scope.showToast("Maintenance Settings Updated!", "success");
                        });
                    })
                    .catch(e => {
                        $scope.$apply(() => {
                            $scope.savingMaint = false; 
                            $scope.showToast("Error: " + e.message, "error");
                        });
                    });
            };

            // --- LIVE SCHEDULE LOGIC ---
            function checkLiveStatus() {
                if(!$scope.config.schedule) return;
                var now = new Date().getTime();
                let closestFutureTime = Infinity;
                let upcomingIndex = -1;
                
                $scope.config.schedule.forEach(function(s) {
                    s.isLive = false; s.isUpcoming = false; s.countdown = "";
                });

                $scope.config.schedule.forEach(function(s, index) {
                    if(!s.timer) return; 
                    var start = new Date(s.timer).getTime();
                    if(isNaN(start)) return;
                    var end = start + (2 * 60 * 60 * 1000); 

                    if (s.endTime && s.endTime.includes(':')) {
                        var parts = s.endTime.split(':');
                        var d = new Date(s.timer);
                        d.setHours(parseInt(parts[0]), parseInt(parts[1]), 0);
                        end = d.getTime();
                        if(end < start) end += 86400000;
                    }
                    
                    if (now >= start && now < end) { s.isLive = true; } 
                    else if (now < start) {
                        if (start < closestFutureTime) { closestFutureTime = start; upcomingIndex = index; }
                    }
                });

                if (upcomingIndex !== -1) {
                    let s = $scope.config.schedule[upcomingIndex];
                    s.isUpcoming = true;
                    let diff = new Date(s.timer).getTime() - now;
                    if (diff > 0) {
                        let d = Math.floor(diff / (1000 * 60 * 60 * 24));
                        let h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                        let m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                        let sec = Math.floor((diff % (1000 * 60)) / 1000);
                        s.countdown = (d>0 ? d+"d " : "") + (h<10?"0"+h:h) + "h " + (m<10?"0"+m:m) + "m " + (sec<10?"0"+sec:sec) + "s";
                    }
                }
            }
            $interval(checkLiveStatus, 1000);

            // --- HELPER FUNCTIONS ---
            $scope.addDriver = () => $scope.config.standings.push({ name: "Driver", team: "Team", points: 0, image: "" });
            $scope.removeDriver = (i) => { if(confirm("Delete?")) $scope.config.standings.splice(i, 1); };
            $scope.moveUp = (i) => { if(i>0) [$scope.config.standings[i], $scope.config.standings[i-1]] = [$scope.config.standings[i-1], $scope.config.standings[i]]; };
            $scope.moveDown = (i) => { if(i<$scope.config.standings.length-1) [$scope.config.standings[i], $scope.config.standings[i+1]] = [$scope.config.standings[i+1], $scope.config.standings[i]]; };
            $scope.sortDrivers = () => { if(confirm("Sort?")) $scope.config.standings.sort((a,b) => b.points - a.points); };
            
            $scope.addSession = () => $scope.config.schedule.push({ day: "FRI", date: "", name: "", time: "", endTime: "", timer: "" });
            $scope.removeSession = (i) => { if(confirm("Delete?")) $scope.config.schedule.splice(i, 1); };
            $scope.moveSessionUp = (i) => { if(i>0) [$scope.config.schedule[i], $scope.config.schedule[i-1]] = [$scope.config.schedule[i-1], $scope.config.schedule[i]]; };
            $scope.moveSessionDown = (i) => { if(i<$scope.config.schedule.length-1) [$scope.config.schedule[i], $scope.config.schedule[i+1]] = [$scope.config.schedule[i+1], $scope.config.schedule[i]]; };

            $scope.addStream = () => $scope.config.streamLinks.push({ name: "", id: "src_"+Date.now(), url: "" });
            $scope.removeStream = (i) => { if(confirm("Delete?")) $scope.config.streamLinks.splice(i, 1); };
        });
    </script>
</body>
</html>
